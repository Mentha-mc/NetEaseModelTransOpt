(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class u{constructor(){this.convertedFiles=new Map,this.fileItems=[],this.currentPage=1,this.itemsPerPage=5,this.setupEventListeners()}setupEventListeners(){document.querySelectorAll(".tab").forEach(o=>{o.addEventListener("click",()=>this.switchTab(o))});const t=document.getElementById("dropZone"),r=document.getElementById("fileInput"),s=document.getElementById("folderDropZone"),n=document.getElementById("folderInput"),a=document.getElementById("downloadZip");t.addEventListener("click",()=>r.click()),r.addEventListener("change",o=>this.handleFiles(o.target.files)),t.addEventListener("dragover",o=>{o.preventDefault(),o.stopPropagation(),t.classList.add("dragover")}),["dragleave","drop"].forEach(o=>{t.addEventListener(o,i=>{if(i.preventDefault(),i.stopPropagation(),t.classList.remove("dragover"),o==="drop"){const c=i.dataTransfer.files;c.length>0&&this.handleFiles(c)}})}),s.addEventListener("click",()=>n.click()),n.addEventListener("change",o=>this.handleFiles(o.target.files)),s.addEventListener("dragover",o=>{o.preventDefault(),o.stopPropagation(),s.classList.add("dragover")}),["dragleave","drop"].forEach(o=>{s.addEventListener(o,i=>{if(i.preventDefault(),i.stopPropagation(),s.classList.remove("dragover"),o==="drop"){const c=i.dataTransfer.items;c&&Array.from(c).forEach(d=>{if(d.kind==="file"){const l=d.getAsFile();l&&this.handleFiles([l])}})}})}),a.addEventListener("click",()=>this.downloadAsZip())}switchTab(e){document.querySelectorAll(".tab").forEach(r=>{r.classList.remove("active")}),document.querySelectorAll(".tab-content").forEach(r=>{r.classList.remove("active")}),e.classList.add("active");const t=e.getAttribute("data-tab");document.getElementById(`${t}-tab`).classList.add("active")}async handleFiles(e){const t=Array.from(e).filter(r=>r.name.toLowerCase().endsWith(".json"));t.length>0&&(document.getElementById("downloadZip").disabled=!1);for(const r of t)await this.convertFile(r)}async convertFile(e){const t={name:e.name,status:"processing",error:null};this.fileItems.unshift(t),this.renderFileList();try{const r=await this.readFileAsText(e),s=JSON.parse(r);if(!this.validateJsonStructure(s))throw new Error("JSON格式不正确。需要包含mesh数组，每个mesh需要包含vertices和indices数组。");const n=this.convertJsonToObj(s);this.convertedFiles.set(e.name.replace(".json",".obj"),n),t.status="success";const a=document.getElementById("downloadZip");a.disabled=!1,a.classList.add("ready"),setTimeout(()=>{a.classList.remove("ready")},1e3)}catch(r){t.status="error",t.error=r.message,console.error("转换错误:",r)}this.renderFileList()}readFileAsText(e){return new Promise((t,r)=>{const s=new FileReader;s.onload=n=>t(n.target.result),s.onerror=n=>r(new Error("文件读取失败")),s.readAsText(e)})}validateJsonStructure(e){if(!e.mesh||!Array.isArray(e.mesh))return!1;for(const t of e.mesh){if(!t.vertices||!Array.isArray(t.vertices)||!t.indices||!Array.isArray(t.indices))return!1;for(const r of t.vertices)if(!r.pos||!Array.isArray(r.pos)||r.pos.length!==3||!r.uvcoord||!Array.isArray(r.uvcoord)||r.uvcoord.length!==2)return!1;for(const r of t.indices)if(!Array.isArray(r)||r.length!==3)return!1}return!0}convertJsonToObj(e){const t=[],r=[];try{for(const a of e.mesh)for(const o of a.vertices){if(!o.pos||!o.uvcoord)throw new Error("顶点数据格式不正确");t.push(o.pos);const i=[o.uvcoord[0],1-o.uvcoord[1]];r.push(i)}let s="";for(const a of t)s+=`v ${a[0]} ${a[1]} ${a[2]}
`;for(const a of r)s+=`vt ${a[0]} ${a[1]}
`;let n=0;for(const a of e.mesh){for(const o of a.indices){const i=o.map(c=>c+n+1);s+=`f ${i[0]}/${i[0]} ${i[1]}/${i[1]} ${i[2]}/${i[2]}
`}n+=a.vertices.length}return s}catch(s){throw new Error(`数据处理错误: ${s.message}`)}}async downloadAsZip(){if(this.convertedFiles.size===0)return;const e=document.getElementById("downloadZip");e.disabled=!0,e.textContent="正在打包...",e.classList.add("loading");try{const t=new JSZip;for(const[a,o]of this.convertedFiles)t.file(a,o);const r=await t.generateAsync({type:"blob"}),s=URL.createObjectURL(r),n=document.createElement("a");n.href=s,n.download="converted_models.zip",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s),e.textContent="打包下载所有转换文件",e.disabled=!1,e.classList.remove("loading"),e.classList.add("success"),setTimeout(()=>{e.classList.remove("success")},2e3)}catch(t){console.error("下载出错:",t),e.textContent="下载失败，请重试",e.disabled=!1,e.classList.remove("loading"),e.classList.add("error"),setTimeout(()=>{e.classList.remove("error"),e.textContent="打包下载所有转换文件"},3e3)}}renderFileList(){const e=document.getElementById("fileList");e.innerHTML="";const t=(this.currentPage-1)*this.itemsPerPage,r=t+this.itemsPerPage,s=this.fileItems.slice(t,r);for(const n of s){const a=document.createElement("div");a.className="file-item";const o=document.createElement("div");o.className="file-info";const i=document.createElement("div");i.className="file-icon",i.innerHTML="📄";const c=document.createElement("div");n.status==="processing"?c.innerHTML=`
                    <div class="processing-status">
                        <strong>${n.name}</strong>
                        <br>
                        <span class="processing">
                            <span class="loading-dots"></span>
                            正在转换...
                        </span>
                    </div>
                `:n.status==="success"?c.innerHTML=`
                    <div>
                        <strong>${n.name}</strong>
                        <br>
                        <span class="success">✓ 转换成功!</span>
                    </div>
                `:c.innerHTML=`
                    <div>
                        <strong>${n.name}</strong>
                        <br>
                        <span class="error">✗ 转换失败: ${n.error}</span>
                    </div>
                `,o.appendChild(i),o.appendChild(c),a.appendChild(o),e.appendChild(a)}if(this.fileItems.length>this.itemsPerPage){const n=document.createElement("div");n.className="pagination",e.appendChild(n),this.updatePagination()}}updatePagination(){const e=Math.ceil(this.fileItems.length/this.itemsPerPage),t=document.querySelector(".pagination");if(t.innerHTML="",e<=1)return;const r=document.createElement("button");r.className=`page-btn prev ${this.currentPage===1?"disabled":""}`,r.textContent="←",r.dataset.page=(this.currentPage-1).toString(),t.appendChild(r);const s=5;let n=Math.max(1,this.currentPage-Math.floor(s/2)),a=Math.min(e,n+s-1);if(a-n+1<s&&(n=Math.max(1,a-s+1)),n>1){const i=document.createElement("button");if(i.className="page-btn",i.textContent="1",i.dataset.page="1",t.appendChild(i),n>2){const c=document.createElement("span");c.className="page-ellipsis",c.textContent="...",t.appendChild(c)}}for(let i=n;i<=a;i++){const c=document.createElement("button");c.className=`page-btn ${i===this.currentPage?"active":""}`,c.textContent=i.toString(),c.dataset.page=i.toString(),t.appendChild(c)}if(a<e){if(a<e-1){const c=document.createElement("span");c.className="page-ellipsis",c.textContent="...",t.appendChild(c)}const i=document.createElement("button");i.className="page-btn",i.textContent=e.toString(),i.dataset.page=e.toString(),t.appendChild(i)}const o=document.createElement("button");o.className=`page-btn next ${this.currentPage===e?"disabled":""}`,o.textContent="→",o.dataset.page=(this.currentPage+1).toString(),t.appendChild(o),t.addEventListener("click",i=>{const c=i.target.closest(".page-btn");c&&!c.classList.contains("disabled")&&(this.currentPage=parseInt(c.dataset.page),this.renderFileList())})}}window.addEventListener("load",()=>new u);
